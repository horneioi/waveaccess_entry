- name: Ensure prerequisites are installed
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
    update_cache: yes
  when: state == "present"

- name: Create directory for Docker key
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  when: state == "present"

- name: Download Docker GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: '0644'
  when: state == "present"

- name: Add Docker repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
    state: present
  when: state == "present"

- name: Install Docker and Compose Plugin
  ansible.builtin.apt:
    name:
      - "docker-ce={{ docker_version | default('latest') }}"
      - "docker-ce-cli={{ docker_version | default('latest') }}"
      - containerd.io
      - docker-compose-plugin
      - python3-docker
    state: present
    update_cache: yes
  when: state == "present"

- name: Cleanup Docker containers and data
  when: state == "absent"
  block:
    - name: Remove all Docker objects
      community.docker.docker_prune:
        containers: yes
        images: yes
        networks: yes
        volumes: yes

    - name: Remove Docker packages
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
          - python3-docker
          - python3-docker-compose
        state: absent
        purge: yes

    - name: Remove Docker GPG key and repo
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/apt/keyrings/docker.asc
        - /etc/apt/sources.list.d/download_docker_com_linux_ubuntu.list

    - name: Remove legacy binary if exists
      ansible.builtin.file:
        path: /usr/local/bin/docker-compose
        state: absent
